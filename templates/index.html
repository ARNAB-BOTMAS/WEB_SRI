<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Srishti Web AI</title>

  <!-- ResponsiveVoice TTS -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=7KRV14Dd"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #animationContainer {
      margin: 20px auto;
      height: 60px;
      width: 100px;
    }
    #responseContainer {
      margin-top: 20px;
      display: none;
      width: 90%;
      max-width: 600px;
      height: 90%;
      max-height: 600px;              /* Fixed height */
      overflow: auto;             /* Scroll if content overflows */
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #444;
      padding: 10px;
      background: #222;
      border-radius: 8px;
    }

    #responseText {
      white-space: pre-wrap;      /* Wrap long lines */
      word-wrap: break-word;      /* Break long words */
      font-family: monospace;
    }

    .mic {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: crimson;
      margin: 0 auto;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    .thinking {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .dot {
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .wave {
      display: flex;
      justify-content: center;
      gap: 3px;
    }
    .bar {
      width: 5px;
      height: 30px;
      background: lime;
      animation: sound 0.6s infinite;
    }
    .bar:nth-child(2) { animation-delay: 0.2s; }
    .bar:nth-child(3) { animation-delay: 0.4s; }
    @keyframes sound {
      0% { height: 10px; }
      50% { height: 40px; }
      100% { height: 10px; }
    }
    .sleeping {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: gray;
      margin: 0 auto;
      animation: slowPulse 3s infinite;
      opacity: 0.3;
    }
    @keyframes slowPulse {
      0% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.1); opacity: 0.5; }
      100% { transform: scale(1); opacity: 0.3; }
    }
    .waking {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: limegreen;
      margin: 0 auto;
      animation: pulse 0.6s infinite;
    }
    .startup {
      width: 60px;
      height: 60px;
      background: deepskyblue;
      border-radius: 50%;
      margin: 0 auto;
      animation: pulseStartup 1s infinite;
    }
    @keyframes pulseStartup {
      0% { transform: scale(1); opacity: 0.6; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 0.6; }
    }
  </style>
</head>
<body>
  <h2>Srishti Web AI</h2>
  <button id="startBtn">Start Assistant</button>
  <button id="stopBtn">Stop Assistant</button>

  <div id="animationContainer"></div>

  <div id="responseContainer">
    <h4>Server Response:</h4>
    <pre id="responseText"></pre>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const animationContainer = document.getElementById('animationContainer');
    const responseContainer = document.getElementById('responseContainer');
    const responseText = document.getElementById('responseText');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert('Speech recognition not supported by your browser.');
      throw new Error('Speech recognition not supported');
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.continuous = true;

    let awake = true;
    let processingResponse = false;

    function setAnimation(state) {
      const html = {
        listening: `<div class="mic"></div>`,
        thinking: `<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`,
        speaking: `<div class="wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>`,
        sleeping: `<div class="sleeping"></div>`,
        waking: `<div class="waking"></div>`,
        startup: `<div class="startup"></div>`
      }[state] || '';
      animationContainer.innerHTML = html;
    }

    function sleepAssistant() {
      awake = false;
      setAnimation('sleeping');
      responseText.textContent = `Assistant sleeping. Say "wake up" to activate.`;
      responseContainer.style.display = 'block';
      responsiveVoice.speak("Going to sleep now.", "UK English Female", {
        pitch: 0.3, rate: 1, volume: 1
      });
    }

    function wakeAssistant() {
      awake = true;
      setAnimation('waking');
      responseText.textContent = `Assistant waking up...`;
      responseContainer.style.display = 'block';
      responsiveVoice.speak("Waking up. How can I help you?", "UK English Female", {
        pitch: 0.3, rate: 1, volume: 1,
        onend: () => {
          if (awake) {
            setAnimation('listening');
            responseText.textContent = `Listening...`;
            try { recognition.start(); } catch (e) {}
          }
        }
      });
    }

    recognition.onstart = () => {
      if (awake && !processingResponse) setAnimation('listening');
      if (!awake) setAnimation('sleeping');
    };

    recognition.onresult = async (event) => {
      if (processingResponse) return;

      const transcript = event.results[event.results.length-1][0].transcript.toLowerCase().trim();
      console.log('Heard:', transcript);

      if (!awake) {
        if (transcript === 'wake up') {
          wakeAssistant();
          responseText.textContent = 'Heard "wake up". Assistant active now.';
        } else {
          responseText.textContent = 'Sleeping... Say "wake up" to activate.';
        }
        responseContainer.style.display = 'block';
        return;
      }

      if (transcript === 'quit' || transcript === 'deactive') {
        responseText.textContent = 'Heard "quit". Going to sleep...';
        responseContainer.style.display = 'block';
        sleepAssistant();
        return;
      }

      processingResponse = true;
      setAnimation('thinking');
      responseText.textContent = `You said: ${transcript}\nSending to server...`;
      responseContainer.style.display = 'block';

      try {
        const res = await fetch('/post-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: transcript }),
        });

        const data = await res.json();
        responseText.textContent = `You said: ${transcript}\nServer response: ${data.received}`;
        setAnimation('speaking');

        responsiveVoice.speak(data.received, "UK English Female", {
          pitch: 0.3, rate: 1, volume: 1,
          onend: () => {
            processingResponse = false;
            if (awake) {
              setAnimation('listening');
              responseText.textContent = 'Listening...';
            }
          }
        });
      } catch (err) {
        responseText.textContent = `Error: ${err.message}`;
        setAnimation('listening');
        processingResponse = false;
      }
    };

    recognition.onerror = (event) => {
      responseText.textContent = `Speech recognition error: ${event.error}`;
      responseContainer.style.display = 'block';
    };

    recognition.onend = () => {
      setTimeout(() => recognition.start(), 200);
    };

    // Start Assistant Button
    startBtn.onclick = () => {
      awake = true;
      setAnimation('startup');
      responseContainer.style.display = 'none';
      setTimeout(() => {
        wakeAssistant();
      }, 2500);
    };

    // Stop Assistant Button
    stopBtn.onclick = () => {
      awake = false;
      recognition.stop();
      sleepAssistant();
    };
  </script>
</body>
</html>
